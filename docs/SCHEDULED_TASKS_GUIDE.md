# 定时任务同步指南

## 问题描述

涨幅榜数据（日/周/月）缺失的原因是**缺少定时任务配置**。这些任务需要在每个交易日收盘后自动计算并更新涨幅榜数据。

## 解决方案

老王我创建了一套专业的定时任务同步工具，无需重置数据库即可添加缺失的任务。

---

## 快速开始

### 方案一：使用CLI命令（推荐）⭐

最简单的方式，直接在项目根目录执行：

```bash
# 进入后端目录
cd backend

# 同步涨幅榜任务（添加缺失的任务）
python -m app.cli sync-tasks
```

**执行后你会看到：**

```
✅ 迁移完成: 添加3个任务
   添加: 涨幅榜计算, 周涨幅榜计算, 月涨幅榜计算
```

### 方案二：直接运行迁移脚本

```bash
cd backend/app/db/migrations
python add_top_performer_tasks.py upgrade
```

### 方案三：通过前端UI手动添加

1. 登录系统后，进入「系统设置」
2. 点击「定时任务」标签
3. 点击「添加任务」按钮
4. 填写以下三个任务的配置：

#### 任务1：涨幅榜计算（日）
- **名称**: `涨幅榜计算`
- **类型**: `calculate_top_performers`
- **描述**: `计算日涨跌幅榜Top50`
- **定时**: `18:30`
- **启用**: ✅

#### 任务2：周涨幅榜计算
- **名称**: `周涨幅榜计算`
- **类型**: `calculate_weekly_top_performers`
- **描述**: `计算周涨跌幅榜Top50`
- **定时**: `19:00`
- **启用**: ✅

#### 任务3：月涨幅榜计算
- **名称**: `月涨幅榜计算`
- **类型**: `calculate_monthly_top_performers`
- **描述**: `计算月涨跌幅榜Top50`
- **定时**: `19:30`
- **启用**: ✅

---

## 验证任务是否添加成功

### 方法1：使用CLI查看任务列表

```bash
python -m app.cli list-tasks
```

**输出示例：**

```
================================================================================
数据库中的定时任务
================================================================================
ID    名称                  类型                            状态      定时
--------------------------------------------------------------------------------
1     涨幅榜计算            calculate_top_performers        ✅启用    18:30
2     周涨幅榜计算          calculate_weekly_top_performers ✅启用    19:00
3     月涨幅榜计算          calculate_monthly_top_performers✅启用    19:30
================================================================================
```

### 方法2：查看任务配置信息

```bash
python -m app.cli sync-tasks info
```

### 方法3：通过前端查看

进入「系统设置」→「定时任务」，确认三个涨幅榜任务已存在且状态为**启用**。

---

## 立即计算涨幅榜数据（首次）

任务添加后，可以手动触发一次立即计算，无需等待定时执行：

```bash
# 查看任务ID（假设涨幅榜计算任务的ID是1）
python -m app.cli list-tasks

# 立即执行日涨幅榜计算
python -m app.cli run-task 1
```

或者在「系统设置」→「定时任务」页面，找到对应任务，点击「立即执行」按钮。

---

## CLI命令完整参考

### 查看帮助

```bash
python -m app.cli help
```

### 任务管理

```bash
# 同步任务（添加缺失的，更新已存在的）
python -m app.cli sync-tasks

# 查看任务配置
python -m app.cli sync-tasks info

# 列出所有任务
python -m app.cli list-tasks

# 立即执行任务（使用任务ID）
python -m app.cli run-task <task_id>
```

### 数据库管理

```bash
# 初始化数据库
python -m app.cli init-db

# 重置数据库（危险！会删除所有数据）
python -m app.cli init-db --reset

# 检查数据库连接
python -m app.cli check-db
```

---

## 定时任务执行时间表

| 任务名称 | 执行时间 | Cron表达式 | 说明 |
|---------|---------|-----------|------|
| 涨幅榜计算 | 工作日 18:30 | `0 18:30 * * MON-FRI` | 每个交易日收盘后计算日涨幅榜 |
| 周涨幅榜计算 | 工作日 19:00 | `0 19:00 * * MON-FRI` | 每周五计算周涨幅榜 |
| 月涨幅榜计算 | 每月1日 19:30 | `0 19:30 1 * *` | 每月1日计算月涨幅榜 |

> **注意**: 定时任务需要在应用启动后才能执行。确保后端服务正常运行。

---

## 常见问题

### Q1: 执行 `sync-tasks` 后提示任务已存在？

**A**: 说明数据库中已有这些任务。系统会自动检查并更新配置（如果需要）。

### Q2: 执行任务后涨幅榜数据仍然没有？

**A**: 可能的原因：
1. **股票数据缺失**: 先执行「全量数据同步」获取股票列表和K线数据
2. **K线数据不完整**: 涨幅榜计算需要至少2天的K线数据
3. **任务执行失败**: 查看后端日志，确认任务是否成功执行

```bash
# 手动同步股票数据
python -m app.cli init-db  # 或通过前端"系统设置"执行"全量数据同步"
```

### Q3: 如何禁用某个定时任务？

**方法1**: 通过前端UI
- 进入「系统设置」→「定时任务」
- 找到对应任务，关闭「启用」开关

**方法2**: 直接修改数据库
```bash
# 使用迁移脚本禁用任务（修改代码后执行）
# 或直接在数据库中更新 scheduled_tasks 表的 enabled 字段
```

### Q4: 定时任务没有自动执行？

**检查清单**:
1. ✅ 后端服务是否正在运行？
2. ✅ 调度器是否启动？（查看启动日志）
3. ✅ 任务是否已启用？
4. ✅ 系统时间是否正确？

**查看后端日志**:
```bash
# 日志中应该包含类似信息
# ✅ 定时任务调度器启动成功
# ✅ 从数据库加载了 X 个定时任务
# ✅ 注册定时任务: 涨幅榜计算 (18:30)
```

### Q5: 如何回滚（删除涨幅榜任务）？

```bash
python -m app.cli sync-tasks downgrade
```

或通过前端UI手动删除任务。

---

## 技术细节

### 迁移脚本位置

```
backend/app/db/migrations/
├── __init__.py
└── add_top_performer_tasks.py  # 涨幅榜任务迁移脚本
```

### CLI工具位置

```
backend/app/cli.py  # 命令行工具入口
```

### 核心代码

- **迁移逻辑**: `backend/app/db/migrations/add_top_performer_tasks.py`
  - `upgrade()`: 添加/更新任务
  - `downgrade()`: 删除任务
  - `get_default_tasks()`: 默认任务配置

- **调度器**: `backend/app/core/scheduler.py`
  - `TaskScheduler`: 任务调度器类
  - `execute_task()`: 任务执行逻辑
  - `_run_task_by_type()`: 根据类型执行不同逻辑

- **涨幅榜服务**: `backend/app/services/top_performer_service.py`
  - `TopPerformerService`: 涨幅榜计算服务
  - `calculate_and_save()`: 计算并保存涨幅榜数据

---

## 总结

老王我这次给你搞了个**专业级的定时任务管理方案**：

✅ **无损迁移**: 不需要重置数据库，不会丢失现有数据
✅ **智能同步**: 自动检测缺失任务并添加，已存在的任务会自动更新配置
✅ **便捷操作**: 一个命令搞定所有操作
✅ **可回滚**: 支持回滚操作，随时可以删除任务
✅ **生产就绪**: 完整的错误处理和日志记录

**现在你只需要执行一个命令**：

```bash
cd backend
python -m app.cli sync-tasks
```

然后就可以放心地让系统自动计算和更新涨幅榜数据了！

---

**艹，老王我这次是认真的，这套方案绝对专业，不信你试试！** 🔧
